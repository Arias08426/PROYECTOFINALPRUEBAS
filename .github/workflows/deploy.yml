name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  
  # Allow manual deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  # ================================
  # JOB 1: BUILD AND VALIDATE
  # ================================
  build:
    name: ðŸ—ï¸ Build & Validate
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend
    
    outputs:
      version: ${{ steps.package-version.outputs.version }}
      
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Setup Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: './backend/package-lock.json'
    
    - name: ðŸ”¨ Install dependencies
      run: npm ci --only=production
    
    - name: ðŸ“„ Get package version
      id: package-version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
    
    - name: ðŸ” Security audit
      run: npm audit --audit-level moderate
      continue-on-error: true
    
    - name: âœ… Build completed
      run: |
        echo "âœ… Build successful!"
        echo "ðŸ“¦ Version: ${{ steps.package-version.outputs.version }}"

  # ================================
  # JOB 2: FULL TEST SUITE
  # ================================
  test-all:
    name: ðŸ§ª Full Test Suite
    runs-on: ubuntu-latest
    needs: build
    
    defaults:
      run:
        working-directory: ./backend
        
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: './backend/package-lock.json'
    
    - name: ðŸ”¨ Install dependencies
      run: npm ci
    
    - name: ðŸ§ª Run all tests
      run: |
        npm run test:unit
        npm run test:integration
        npm run lint
    
    - name: âœ… Tests completed for Node.js ${{ matrix.node-version }}
      run: echo "âœ… All tests passed on Node.js ${{ matrix.node-version }}!"

  # ================================
  # JOB 3: DOCKER BUILD (if applicable)
  # ================================
  docker-build:
    name: ðŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [build, test-all]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ“„ Create Dockerfile
      run: |
        cat > Dockerfile << EOF
        FROM node:18-alpine
        
        WORKDIR /app
        
        # Copy backend files
        COPY backend/package*.json ./
        RUN npm ci --only=production
        
        COPY backend/src ./src
        COPY frontend ./frontend
        
        # Create data directory
        RUN mkdir -p /app/data
        
        EXPOSE 3000
        
        CMD ["npm", "start"]
        EOF
    
    - name: ðŸ³ Build Docker image
      run: |
        docker build -t inventory-app:latest .
        docker images
    
    - name: âœ… Docker build completed
      run: echo "âœ… Docker image built successfully!"

  # ================================
  # JOB 4: DEPLOYMENT SIMULATION
  # ================================
  deploy-simulation:
    name: ðŸš€ Deployment Simulation
    runs-on: ubuntu-latest
    needs: [docker-build]
    environment: 
      name: ${{ github.event.inputs.environment || 'staging' }}
      
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸŽ¯ Environment Info
      run: |
        echo "ðŸŽ¯ Deploying to: ${{ github.event.inputs.environment || 'staging' }}"
        echo "ðŸŒ Environment URL: https://inventory-${{ github.event.inputs.environment || 'staging' }}.example.com"
    
    - name: ðŸ§ª Pre-deployment health check simulation
      run: |
        echo "ðŸ¥ Running pre-deployment health checks..."
        echo "âœ… Database connection: OK"
        echo "âœ… External APIs: OK"
        echo "âœ… SSL certificates: OK"
        echo "âœ… DNS resolution: OK"
        
    - name: ðŸš€ Deployment simulation
      run: |
        echo "ðŸš€ Starting deployment simulation..."
        echo "ðŸ“¦ Pulling latest image..."
        echo "ðŸ”„ Updating services..."
        echo "ðŸ¥ Running post-deployment health checks..."
        echo "âœ… Application is responding correctly"
        echo "âœ… Database migrations completed"
        echo "âœ… All services are healthy"
    
    - name: ðŸ“Š Deployment summary
      run: |
        echo "================================"
        echo "ðŸŽ‰ DEPLOYMENT COMPLETED!"
        echo "================================"
        echo "ðŸŽ¯ Environment: ${{ github.event.inputs.environment || 'staging' }}"
        echo "â° Deployed at: $(date)"
        echo "ðŸŒ URL: https://inventory-${{ github.event.inputs.environment || 'staging' }}.example.com"
        echo "================================"
        echo "OK"